name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

env:
  NODE_VERSION: "22.x"

permissions:
  contents: read
  packages: read
  pull-requests: read

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Check source branch is up to date with main
        run: |
          # Add upstream remote to ensure we compare against real main, not stale fork main
          git remote add upstream https://github.com/tetherto/pearpass-app-desktop.git || true
          git fetch upstream main

          BEHIND=$(git rev-list --count HEAD..upstream/main)
          if [ "$BEHIND" -gt 0 ]; then
            echo "::error::Branch is $BEHIND commits behind main. Please update your branch."
            exit 1
          fi

      - name: Enforce linear history
        run: |
          # Use upstream/main as the baseline
          MERGE_COMMITS=$(git log upstream/main..HEAD --merges --oneline | wc -l)
          if [ "$MERGE_COMMITS" -gt 1 ]; then
            echo "::error::Found $MERGE_COMMITS merge commits:"
            # List the specific commits causing the issue
            git log upstream/main..HEAD --merges --pretty=format:"%h %s (%an)"
            echo "" # Ensure newline
            echo "::error::Merge commits detected. Please rebase to maintain linear history."
            exit 1
          fi

      - name: Check required lock files exist
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "::error::package-lock.json is missing"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Validate semantic versioning
        id: semver
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if ! echo "$VERSION" | grep -qE '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$'; then
            echo "::error::Version $VERSION does not follow semantic versioning (MAJOR.MINOR.PATCH)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Check version not already released (if publish label present)
        if: contains(github.event.pull_request.labels.*.name, 'publish')
        run: |
          git fetch --tags
          VERSION="${{ steps.semver.outputs.VERSION }}"
          if git tag | grep -q "^v$VERSION$"; then
            echo "::error::Version v$VERSION has already been released"
            exit 1
          fi

  lint:
    runs-on: ubuntu-latest
    needs: validate-pr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: "https://npm.pkg.github.com"
          scope: "@tetherto"

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Run ESLint
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    needs: validate-pr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: "https://npm.pkg.github.com"
          scope: "@tetherto"

      - name: Install dependencies
        run: npm ci --install-links
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Run tests
        run: npm test

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: "https://npm.pkg.github.com"
          scope: "@tetherto"

      - name: Install dependencies
        run: npm ci --install-links
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Extract translations
        run: |
          npm run lingui:extract
          npm run lingui:compile

      - name: Build application
        run: npm run build:pear
