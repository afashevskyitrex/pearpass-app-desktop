name: Verify

on:
  pull_request:
    types: [labeled, synchronize]
    branches:
      - main

env:
  NODE_VERSION: "22.x"
  CHANNEL_LINK: "pear://8mzabhx3kbpq88eqy7wiuu1csjqqkry19c3di8nixu5rgt6cmupy"

permissions:
  contents: read
  packages: read
  pull-requests: write
  checks: write

jobs:
  verify:
    if: contains(github.event.pull_request.labels.*.name, 'verify')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://npm.pkg.github.com"
          scope: "@tetherto"

      - name: Install dependencies
        run: npm install --install-links
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Extract translations
        run: |
          npm run lingui:extract
          npm run lingui:compile

      - name: Build application
        run: npm run build:pear

      - name: Run verification tests
        id: verify_tests
        run: npm run test:e2e
        continue-on-error: true

      - name: Report test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testsPassed = '${{ steps.verify_tests.outcome }}' === 'success';
            const body = testsPassed 
              ? '✅ Verification tests passed successfully.'
              : '❌ Verification tests failed. Please review the test output above.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail job if tests failed
        if: steps.verify_tests.outcome != 'success'
        run: |
          echo "::error::Verification tests failed"
          exit 1